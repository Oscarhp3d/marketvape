{% extends 'base.html' %}
{% load static %}

{% block title %}Catálogo - VapeMarket{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <!--  Catálogo -->
    <div class="col-lg-8">
      <h3 class="fw-bold mb-4">Catálogo de Productos</h3>

      <div class="row g-4">
        {% for producto in productos %}
        <div class="col-md-4 col-sm-6">
          <div class="card h-100 border-0 shadow-sm">
            <img src="{{ producto.imagen }}" class="card-img-top" style="height:230px; object-fit:cover;" alt="{{ producto.nombre }}">
            <div class="card-body text-center">
              <h6 class="fw-semibold">{{ producto.nombre }}</h6>
              <p class="text-muted">${{ producto.precio }}</p>
              <button class="btn btn-vape mt-2 w-100 agregar-carrito" data-id="{{ producto.id }}">
                <i class="bi bi-cart-plus"></i> Agregar al Carrito
              </button>
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-center text-muted">No hay productos disponibles.</p>
        {% endfor %}
      </div>
    </div>

    <!--  Carrito lateral -->
    <div class="col-lg-4 mt-4 mt-lg-0">
      <div class="card shadow-sm p-3">
        <h5 class="fw-bold mb-3"><i class="bi bi-cart"></i> Carrito</h5>

        <!--  Lista de productos -->
        <ul class="list-group mb-3" id="lista-carrito">
          {% for item in carrito_items %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ item.producto.nombre }}
            <span class="badge bg-primary rounded-pill">{{ item.cantidad }}</span>
          </li>
          {% empty %}
          <li class="list-group-item text-center text-muted">Tu carrito está vacío.</li>
          {% endfor %}
        </ul>

        <!-- Total -->
        <p class="fw-bold text-end">Total: $<span id="total-carrito">{{ total|default:0 }}</span></p>

        <!--  Botón de resumen -->
        <a href="{% url 'productos:resumen_pedido' %}" class="btn btn-dark w-100 mt-2">
          Ver resumen del pedido
        </a>
      </div>
    </div>
  </div>
</div>

<!--  Script AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.agregar-carrito').forEach(boton => {
    boton.addEventListener('click', function() {
      const productoId = this.getAttribute('data-id');
      const botonOriginal = this;
      const iconoOriginal = botonOriginal.innerHTML;

      fetch(`/agregar_ajax/${productoId}/`)
        .then(response => response.json())
        .then(data => {
          if (!data.ok) return;

          //  Actualizar total
          document.querySelector('#total-carrito').textContent = data.total;

          //  Actualizar lista lateral
          const lista = document.querySelector('#lista-carrito');
          lista.innerHTML = '';
          data.carrito.forEach(item => {
            const li = document.createElement('li');
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `${item.nombre} <span class="badge bg-primary rounded-pill">${item.cantidad}</span>`;
            lista.appendChild(li);
          });

          //  Animación del botón
          botonOriginal.innerHTML = " Agregado";
          botonOriginal.disabled = true;
          botonOriginal.classList.add("btn-success");
          setTimeout(() => {
            botonOriginal.innerHTML = iconoOriginal;
            botonOriginal.disabled = false;
            botonOriginal.classList.remove("btn-success");
          }, 1000);
        })
        .catch(error => console.error("Error al agregar:", error));
    });
  });
});
</script>
{% endblock %}
